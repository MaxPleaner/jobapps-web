<br>
<br>
<!-- hold your horses -->

<div id="rootLinkContainer" class="container">
  <div class="row"><%= render "root_link" %></div>
</div>

<div id="statsContainer" class="container">
  <div class="row"><%= render "stats" %></div>
</div>

<div id="scraperButtonsContainer" class="container">
  <div class="row"><%= render "import_from_angellist_button" %></div>
  <div class="row"><%= render "import_from_stackoverflow_button" %></div>
  <div class="row"><%= render "import_from_remoteok_button" %></div>
</div>

<div id="yamlImportContainer" class="container">
  <div class="row"><%= render "import_from_yaml_button" %></div>
</div>

<div id="filterOptionsContainer" class="container">
  <div class="row"><%= render "filter_options" %></div>
</div>

<div id="autoscrollButtonContainer" class="container">
    <div class="row"><%= render "autoscroll_button" %></div>
</div>

<div id="categoryTogglerContainer" class="container">
  <div class="row"><%= render "category_toggler_button" %></div>
</div>

<div id="searchResultsContainer" class="container">
  <div class="row"><%= render "search_results" %></div>
</div>

<div id="searchContainer" class="container">
  <div class="row"><%= render "search" %></div>
</div>

<% if @most_recent_skips %>

<!--  -->
<!-- Companies List View -->
<!--  -->

<form action="/" method="GET">
  <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
  <input type="hidden" name="filter" value="most_recent_skips">
  <input class="large-text" type="number" name="most_recent_skip_count" placeholder="number" value="<%= @most_recent_skip_count || 5 %>">
  <input type="submit" value="# to show">
</form> <br> <br>

  <% @most_recent_skips.reverse_each do |company| %>
    <pre class="company">
      <a href="/?id=<%= company.id %>"><%= raw company.attributes.ai(html: true).html_safe %></a>
      <%#= raw company.attributes.ai(html: true).html_safe %>
    </pre>
  <% end %>

<% elsif @company && !@company.persisted? %>
<% else %>

<!--  -->
<!-- Company Show View -->
<!--  -->

  <% if session["only_todos"] %>
    <% page_name = "showing todos" %>
    <% companies_query = Company.todo %>
  <% elsif session["most_recent_skips"] %>
    <% page_name = "showing skipped" %>
    <% companies_query = Company.skipped %>
  <% elsif session["no_filter"] %>
    <% page_name = "showing all" %>
    <% companies_query = Company.all %>
  <% elsif session["starred"] %>
    <% page_name = "showing starred" %>
    <% companies_query = Company.unscoped.where(starred: true) %>
  <% else %>
    <% page_name = "showing blanks" %>
    <% companies_query = Company.blank %>
  <% end %>

<% if session["recently_edited_companies"]&.any? %>
  <div class="row">
    <div class="col-xs-12">
      <div class="stats">
        <i>recently edited companies</i><br>
        <% session[:recently_edited_companies].reverse_each do |attrs| %>
          <span class="company-attr">
            <a href="/?id=<%= attrs["id"] %>">
              <%= attrs["name"] %>: <%= attrs.keys - ["name", "id"] %>
            </a>
          </span> <br>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

  <% previous_id = companies_query.where("id < ?", @company&.id).last&.id || companies_query.order(id: :desc).first&.id || @company.get_previous&.id || @company.get_next&.id || @company&.id %>
  <% previous_name = Company.find_by(id: previous_id)&.name || @company.get_previous&.name || @company.get_next&.name || @company&.name %>
  <% next_id = companies_query.where("id > ?", @company&.id).first&.id || companies_query.first&.id || @company.get_next&.id | @company.get_previous&.id || @company&.id %>
  <% next_name = Company.find_by(id: next_id)&.name || @company.get_next&.name || @company.get_previous&.id || @company&.id %>

<div class="row">
    <div class="col-xs-12">
      <a href="/?id=<%= previous_id %>"><span class="button">Previous company: <%= previous_name %> (<%= page_name %>)</span></a> <br>
    </div>
  </div>
  <div class="row">
    <div class="col-xs-12">
      <a href="/?id=<%= next_id %>"><span class="button">Next company: <%= next_name %> (<%= page_name %>)</span></a> <br>
    </div>
  </div>
  <br>

  <div class="row">
    <div class="col-xs-12">
      <pre class="company">
        <%= raw @company.attributes.ai(html: true).html_safe %>
      </pre> <br>
    </div>
  </div>
  <br>

<div class="row inline-forms">

      <% if @company.starred %>
        <form action="/update" method="POST" >
          <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
          <input type="hidden" name="id" value="<%= @company.id %>">
          <input type="hidden" name="cmd" value="unstar">
          <input type="submit" value="unstar">
        </form>
      <% else %>
        <form action="/update" method="POST" >
          <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
          <input type="hidden" name="id" value="<%= @company.id %>">
          <input type="hidden" name="cmd" value="star">
          <input type="submit" value="star">
        </form>
      <% end %>

    <form method="POST" action="/update?id=<%= @company.id %>&cmd=quick_skip">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <input type="hidden" name="next_id" value=<%= companies_query.where("id > ?", @company.id).first&.id || companies_query.first&.id || @company.get_next&.id %>>
      <input type="submit" value="skip & next">
    </form>
    <form method="POST" action="/update?id=<%= @company.id %>&cmd=quick_apply">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <input type="hidden" name="next_id" value=<%= companies_query.where("id > ?", @company.id).first&.id || companies_query.first&.id || @company.get_next&.id %>>
      <input type="submit" value="apply & next">
    </form>
    <form method="POST" action="/update?id=<%= @company.id %>&cmd=quick_todo">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <input type="hidden" name="next_id" value=<%= companies_query.where("id > ?", @company.id).first&.id || companies_query.first&.id || @company.get_next&.id %>>
      <input type="submit" value="todo & next">
    </form>
    <form method="POST" action="/update?id=<%= @company.id %>&cmd=quick_rejected">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <input type="hidden" name="next_id" value=<%= companies_query.where("id > ?", @company.id).first&.id || companies_query.first&.id || @company.get_next&.id %>>
      <input type="submit" value="rejected & next">
    </form>
</div>

<hr>

<div class="row">
  <div class="col-xs-12">
    <form class="form-with-box" method="POST" action="/update?id=<%= @company.id %>&cmd=skip_with_note">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <input type="hidden" name="next_id" value=<%= companies_query.where("id > ?", @company.id).first&.id || companies_query.first&.id || @company.get_next&.id %>>
      <input class="large-text" type="text" name="update_value">
      <input type="submit" value="skip with note">
    </form> <br>
  </div>
</div>
<div class="row">
  <div class="col-xs-12">
    <form class="form-with-box" method="POST" action="/update?id=<%= @company.id %>&cmd=apply_with_note">
      <input type="hidden" name="next_id" value=<%= companies_query.where("id > ?", @company.id).first&.id || companies_query.first&.id || @company.get_next&.id %>>
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <input class="large-text" type="text" name="update_value">
      <input type="submit" value="apply with note">
    </form> <br>
  </div>
</div>
<div class="row">
  <div class="col-xs-12">
    <form class="form-with-box" method="POST" action="/update?id=<%= @company.id %>&cmd=todo_with_note">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <input  class="large-text" type="text" name="update_value">
      <input type="submit" value="todo with note">
    </form> <br>
  </div>
</div>
<div class="row">
  <div class="col-xs-12">
    <form class="form-with-box" method="POST" action="/update?id=<%= @company.id %>&cmd=not_laughing">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <input  class="large-text" type="text" name="update_value">
      <input type="submit" value="not laughing">
    </form> <br>
  </div>
</div>
<div class="row">
  <div class="col-xs-12">
    <form class="form-with-box" method="POST" action="/update?id=<%= @company.id %>&cmd=set_category">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <input  class="large-text" type="text" name="update_value">
      <input type="submit" value="set category">
    </form> <br>
  </div>
</div>
<div class="row">
  <div class="col-xs-12">
    <form method="POST" action="/update?id=<%= @company.id %>&cmd=undo_todo">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <input type="submit" value="undo todo">
    </form> <br>
  </div>
</div>
<div class="row">
  <div class="col-xs-12">
    <form method="POST" action="/update?id=<%= @company.id %>&cmd=undo_skip">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <input type="submit" value="undo skip">
    </form> <br>
  </div>
</div>
<div class="row">
  <div class="col-xs-12">
    <form method="POST" action="/update?id=<%= @company.id %>&cmd=undo_apply">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      <input type="submit" value="undo apply">
    </form> <br>
  </div>
</div>










<% end %>
  <% if @company&.persisted? %>
    <h4> Edit company: <b><%= @company.name %><b> </h4>
    <%= render "company_form", company: @company %>
  <% end %>
  <h4> New company </h4>
  <%= render "company_form", company: nil %>
<br>
<br>
<br>
<br>
<br>
<br>

<script>
<% if session[:autoscroll] %>
  $( document ).on('turbolinks:load', function() {
    $('body').scrollTo('.company');
  })
<% end %>
</script>


